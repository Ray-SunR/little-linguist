# Testing Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:subagent-driven-development to implement this plan task-by-task.

**Goal:** Add unit and integration tests to improve code coverage and reliability.

**Architecture:** Use `vitest` for both unit and integration tests. Unit tests will target pure functions and classes with mocked dependencies. Integration tests will simulate API calls.

**Tech Stack:** `vitest`, `vi` (mocks), `node-mocks-http` (if needed for API testing), `supabase`.

### Task 1: Unit Test for Tokenization Utils

**Files:**
- Test: `lib/core/utils/__tests__/tokenization.test.ts` (Create)
- Source: `lib/core/utils/tokenization.ts`

**Step 1: Write the failing test**

```typescript
import { describe, it, expect } from 'vitest';
import { tokenizeText } from '../tokenization';

describe('tokenizeText', () => {
    it('should correctly tokenize a simple sentence', () => {
        const text = "Hello world.";
        const tokens = tokenizeText(text);
        expect(tokens).toHaveLength(2);
        expect(tokens[0].text).toBe('Hello');
        expect(tokens[1].text).toBe('world');
        expect(tokens[1].punctuation).toBe('.');
    });

    it('should handle multiple spaces', () => {
        const text = "Hello   world";
        const tokens = tokenizeText(text);
        expect(tokens).toHaveLength(2);
        expect(tokens[1].start).toBe(8); // "Hello" (5) + "   " (3)
    });
});
```

**Step 2: Run test to verify it fails (or passes if logic is correct)**
Run: `npx vitest run lib/core/utils/__tests__/tokenization.test.ts`

**Step 3: Commit**
```bash
git add lib/core/utils/__tests__/tokenization.test.ts
git commit -m "test: add unit tests for tokenization utils"
```

### Task 2: Unit Test for Story Repository

**Files:**
- Test: `lib/core/stories/__tests__/repository.test.ts` (Create)
- Source: `lib/core/stories/repository.server.ts`

**Step 1: Write the failing test**
Mock Supabase client and test `getStoryById` and `createStory`.

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { StoryRepository } from '../repository.server';

// Mock Supabase
const mockSelect = vi.fn();
const mockInsert = vi.fn();
const mockUpdate = vi.fn();
const mockEq = vi.fn();
const mockSingle = vi.fn();

const mockSupabase = {
    from: vi.fn(() => ({
        select: mockSelect,
        insert: mockInsert,
        update: mockUpdate,
    })),
} as any;

mockSelect.mockReturnValue({ eq: mockEq });
mockInsert.mockReturnValue({ select: vi.fn(() => ({ single: mockSingle })) });
mockUpdate.mockReturnValue({ eq: vi.fn(() => ({ select: vi.fn(() => ({ single: mockSingle })) })) }); // Fix chain
// ... set up return values in test
```

**Step 2: Run test**
Run: `npx vitest run lib/core/stories/__tests__/repository.test.ts`

**Step 3: Commit**
```bash
git add lib/core/stories/__tests__/repository.test.ts
git commit -m "test: add unit tests for story repository"
```

### Task 3: Unit Test for Gemini Narration Provider

**Files:**
- Test: `lib/features/narration/implementations/__tests__/gemini-provider.test.ts` (Create)
- Source: `lib/features/narration/implementations/gemini-provider.ts`

**Step 1: Write the failing test**
Since it delegates to `WebSpeechNarrationProvider`, we should verify it calls the delegate methods. We might need to mock `WebSpeechNarrationProvider`.

**Step 2: Run test**
Run: `npx vitest run lib/features/narration/implementations/__tests__/gemini-provider.test.ts`

**Step 3: Commit**
```bash
git add lib/features/narration/implementations/__tests__/gemini-provider.test.ts
git commit -m "test: add unit tests for gemini narration provider"
```

### Task 4: Integration Test for Story API (Skeleton)

**Files:**
- Test: `tests/integration/story-api.test.ts` (Create)
- Source: `app/api/story/route.ts`

**Step 1: Write the failing test**
Since this is an API route, we can test the POST handler by mocking the request and response, or mocking the underlying services. Given it calls external AI services, we MUST mock those services (`GoogleGenerativeAI`, `Bedrock`, etc.) to avoid real costs and latency.

**Step 2: Run test**
Run: `npx vitest run tests/integration/story-api.test.ts`

**Step 3: Commit**
```bash
git add tests/integration/story-api.test.ts
git commit -m "test: add integration test for story api"
```
