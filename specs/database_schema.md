# Database Schema Specification

This document details the Supabase database schema for the Little Linguist application. The schema is optimized for a multi-profile household model with personalized learning, SRS vocabulary tracking, and AI story generation.

## Overview
- **Project Ref**: `tawhvgzctlfavucdxwbt`
- **Schema**: `public`
- **Total Tables**: 14

---

## 1. Core Profile Management

### `profiles`
Stores guardian/household account information.
- **Usage**: Primary account record linked to Supabase Auth. Controls subscription status and billing.
- **Columns**:
  - `id` (uuid, PK): References `auth.users(id)`.
  - `email` (text): Guardian email.
  - `subscription_status` (text): Current tier (e.g., 'free', 'premium').
  - `stripe_customer_id` (text): Reference for billing.
  - `created_at` (timestamptz): Account creation time.

### `children`
Individual learner profiles within a household.
- **Usage**: Each guardian can manage multiple child profiles. Stores personalization preferences.
- **Columns**:
  - `id` (uuid, PK): Unique child identifier.
  - `owner_user_id` (uuid, FK): References `profiles(id)`.
  - `first_name` (text): Child's name.
  - `last_name` (text): Optional.
  - `birth_year` (int), `gender` (text): Demographic info for AI personalization.
  - `interests` (text[]): List of topics the child likes.
  - `ability_tier` (text): Reading level.
  - `learning_objectives` (jsonb): Specific goals.
  - `avatar_paths` (jsonb): Array of storage paths for profile photos.
  - `primary_avatar_index` (int): Active avatar selection.
  - `created_at`, `deleted_at` (timestamptz).

---

## 2. Book & Content Engine

### `books`
Lightweight metadata for all books (system-provided and AI-generated).
- **Usage**: Optimized for library listing and initial loading.
- **Columns**:
  - `id` (uuid, PK): Unique book identifier.
  - `book_key` (text, Unique): Human-readable slug (e.g., 'the-magic-forest').
  - `title` (text).
  - `origin` (text): `system` or `ai_generated`.
  - `owner_user_id` (uuid, FK): References `profiles(id)`. NULL for system books.
  - `child_id` (uuid, FK): References `children(id)`. Sets child-specific visibility.
  - `voice_id` (text): Preferred TTS voice.
  - `estimated_reading_time` (int): In minutes.
  - `total_tokens` (int): Count of words for progress tracking.
  - `cover_image_path` (text): Path in `book-assets` bucket.
  - `schema_version` (int): Version of content structure (1=V1, 2=V2).
  - `metadata` (jsonb), `created_at`, `updated_at`.

### `book_contents`
Heavy content data stored separately to optimize metadata-only requests.
- **Usage**: Lazy-loaded when the reader is opened.
- **Columns**:
  - `id` (uuid, PK).
  - `book_id` (uuid, FK, Unique): References `books(id)`.
  - `full_text` (text): Complete story text.
  - `tokens` (jsonb): Array of tokenized words with metadata for reader logic.
  - `created_at`, `updated_at`.

### `book_audios`
Narration chunks generated by TTS (e.g., AWS Polly).
- **Usage**: Stores audio file paths and synchronization timings for "karaoke" highlighting.
- **Columns**:
  - `id` (uuid, PK).
  - `book_id` (uuid, FK): References `books(id)`.
  - `chunk_index` (int): Order of the audio segment.
  - `voice_id` (text): Voice used for this chunk.
  - `audio_path` (text): Storage path in `book-assets`.
  - `timings` (jsonb): Word-level synchronization data.
  - `start_word_index`, `end_word_index` (int): Range of tokens covered.
  - `owner_user_id` (uuid): References auth user.

### `book_media`
Visual assets associated with books.
- **Usage**: Stores scene illustrations for AI stories or supplemental images for system books.
- **Columns**:
  - `id` (uuid, PK).
  - `book_id` (uuid, FK): References `books(id)`.
  - `path` (text): Storage path in `book-assets`.
  - `media_type` (text): Default 'image'.
  - `after_word_index` (int): Where the image appears in the text flow.
  - `metadata` (jsonb): Captions, alt text, etc.

---

## 3. Learning & Progress

### `child_book_progress`
Persistence for reading state.
- **Usage**: Allows children to resume books where they left off and tracks completion.
- **Columns**:
  - `child_id`, `book_id` (Composite PK).
  - `last_read_at` (timestamptz).
  - `last_token_index` (int): Position of the last read word.
  - `last_shard_index` (int): Position in audio narration.
  - `is_completed` (boolean).
  - `total_read_seconds` (int).
  - `playback_speed` (numeric).

### `learning_sessions`
Tracking distinct activity windows.
- **Usage**: Groups events (taps, reviews) for analytics and point calculations.
- **Columns**:
  - `id` (uuid, PK).
  - `child_id` (uuid, FK).
  - `book_id` (uuid, FK).
  - `session_type` (text): 'reading', 'review', or 'creation'.
  - `started_at`, `ended_at` (timestamptz).
  - `summary` (jsonb).

### `point_transactions`
Ledger-based economy system.
- **Usage**: Auditable history of points earned from learning or spent on AI stories.
- **Columns**:
  - `id` (uuid, PK).
  - `child_id` (uuid, FK).
  - `session_id` (uuid, FK).
  - `amount` (int): Positive for earnings, negative for spending.
  - `reason` (text): Description of the transaction.
  - `idempotency_key` (text): Prevents duplicate rewards.
  - `created_at`.

---

## 4. Vocabulary & SRS

### `word_insights`
Global cache for AI-generated word data.
- **Usage**: Prevents redundant AI calls for the same words. Shared across all users.
- **Columns**:
  - `id` (uuid, PK).
  - `word` (text, Unique per language): Normalized term.
  - `definition` (text): Kid-friendly description.
  - `pronunciation` (text).
  - `examples` (jsonb): Array of usage examples.
  - `audio_path` (text): Combined definition audio.
  - `word_audio_path` (text): High-quality word pronunciation.
  - `example_audio_paths` (jsonb).
  - `timing_markers`, `example_timing_markers` (jsonb): Synchronization for audio.
  - `updated_at`.

### `child_vocab`
Personalized vocabulary list for each learner using Spaced Repetition (SRS).
- **Usage**: Tracks word mastery for a specific child.
- **Columns**:
  - `child_id`, `word_id` (Composite PK).
  - `status` (text): 'learning', 'reviewing', or 'mastered'.
  - `source_type` (text): 'clicked', 'imported', or 'manual'.
  - `origin_book_id` (uuid, FK).
  - `next_review_at` (timestamptz): Calculated SRS date.
  - `interval_days` (int), `ease` (numeric), `reps` (int): SRS algorithm parameters.
  - `created_at`, `last_seen_at`.

---

## 5. AI Features & Usage

### `stories`
Specialized metadata for AI-generated story flows.
- **Usage**: Links to `books` but stores additional generation-specific data like prompts and scenes.
- **Columns**:
  - `id` (uuid, PK): References `books(id)`.
  - `guardian_id` (uuid, FK).
  - `child_id` (uuid, FK).
  - `main_character_description` (text).
  - `scenes` (jsonb): Array of scene objects with prompts and text.
  - `avatar_url` (text): Reference photo path for character consistency.
  - `status` (text): 'generating', 'completed', or 'failed'.
  - `created_at`, `updated_at`.

### `subscription_plans`
Defines service level agreements.
- **Usage**: Configures quotas for AI features.
- **Columns**:
  - `code` (text, PK): 'free', 'basic', 'premium'.
  - `name` (text).
  - `quotas` (jsonb): Limits (e.g., `{ "stories_per_month": 5 }`).

### `usage_meter`
Tracking consumption against plan limits.
- **Usage**: Enforces quotas across different AI services.
- **Columns**:
  - `id` (uuid, PK).
  - `owner_user_id` (uuid, FK): References `profiles(id)`.
  - `category` (text): 'story_gen', 'tts_chars', 'ai_images'.
  - `quantity` (bigint): Metric value.
  - `ref_id` (uuid): ID of the related asset or job.
  - `created_at`.
